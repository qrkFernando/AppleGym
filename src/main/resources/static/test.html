<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test AppleGym API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test AppleGym API</h1>
        
        <div class="test-section">
            <h3>Test de Login</h3>
            <div>
                <label>Email: <input type="email" id="email" value="juan@test.com"></label><br><br>
                <label>Password: <input type="password" id="password" value="12345678"></label><br><br>
                <button onclick="testLogin()">Test Login</button>
            </div>
            <div id="login-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>Test de Productos</h3>
            <button onclick="testProducts()">Cargar Productos</button>
            <div id="products-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>Test de Carrito</h3>
            <button onclick="testAddToCart()">Agregar al Carrito (requiere login)</button>
            <button onclick="testGetCart()">Ver Carrito</button>
            <div id="cart-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>Test de Pago</h3>
            <button onclick="testPaymentMethods()">Métodos de Pago</button>
            <button onclick="testProcessPayment()">Procesar Pago (requiere carrito)</button>
            <div id="payment-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let authToken = null;

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('login-result');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                resultDiv.style.display = 'block';

                if (response.ok) {
                    authToken = data.accessToken;
                    resultDiv.innerHTML = `<span class="success">✓ Login exitoso!</span><br>
                        <strong>Usuario:</strong> ${data.cliente.nombreCliente}<br>
                        <strong>Email:</strong> ${data.cliente.email}<br>
                        <strong>Token:</strong> ${authToken.substring(0, 50)}...`;
                } else {
                    resultDiv.innerHTML = `<span class="error">✗ Error:</span> ${data.message || 'Error de login'}`;
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<span class="error">✗ Error de conexión:</span> ${error.message}`;
            }
        }

        async function testProducts() {
            const resultDiv = document.getElementById('products-result');
            
            try {
                const response = await fetch('/api/productos');
                const data = await response.json();
                resultDiv.style.display = 'block';

                if (response.ok) {
                    resultDiv.innerHTML = `<span class="success">✓ Productos cargados:</span><br>
                        <strong>Total:</strong> ${data.length} productos<br>
                        ${data.map(p => `• ${p.nombre} - $${p.precio} (Stock: ${p.stock})`).join('<br>')}`;
                } else {
                    resultDiv.innerHTML = `<span class="error">✗ Error:</span> ${JSON.stringify(data)}`;
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<span class="error">✗ Error de conexión:</span> ${error.message}`;
            }
        }

        async function testAddToCart() {
            if (!authToken) {
                alert('Primero debes hacer login');
                return;
            }

            const resultDiv = document.getElementById('cart-result');
            
            try {
                const response = await fetch('/api/carrito/item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        tipo: 'PRODUCTO',
                        idItem: 1,
                        cantidad: 2
                    })
                });

                const data = await response.json();
                resultDiv.style.display = 'block';

                if (response.ok) {
                    resultDiv.innerHTML = `<span class="success">✓ Producto agregado al carrito</span><br>
                        ${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.innerHTML = `<span class="error">✗ Error:</span> ${JSON.stringify(data)}`;
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<span class="error">✗ Error de conexión:</span> ${error.message}`;
            }
        }

        async function testGetCart() {
            if (!authToken) {
                alert('Primero debes hacer login');
                return;
            }

            const resultDiv = document.getElementById('cart-result');
            
            try {
                const response = await fetch('/api/carrito', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                resultDiv.style.display = 'block';

                if (response.ok) {
                    resultDiv.innerHTML = `<span class="success">✓ Carrito obtenido:</span><br>
                        <strong>Total:</strong> $${data.total || 0}<br>
                        <strong>Items:</strong> ${data.detalles?.length || 0}<br>
                        ${data.detalles?.map(d => `• ${d.nombreItem} x${d.cantidad} - $${d.precioUnitario}`).join('<br>') || 'Carrito vacío'}`;
                } else {
                    resultDiv.innerHTML = `<span class="error">✗ Error:</span> ${JSON.stringify(data)}`;
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<span class="error">✗ Error de conexión:</span> ${error.message}`;
            }
        }

        async function testPaymentMethods() {
            const resultDiv = document.getElementById('payment-result');
            
            try {
                const response = await fetch('/api/ventas/metodos-pago');
                const data = await response.json();
                resultDiv.style.display = 'block';

                if (response.ok) {
                    resultDiv.innerHTML = `<span class="success">✓ Métodos de pago:</span><br>
                        ${data.metodosDisponibles.map(m => `• ${m.nombre} (${m.id})`).join('<br>')}`;
                } else {
                    resultDiv.innerHTML = `<span class="error">✗ Error:</span> ${JSON.stringify(data)}`;
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<span class="error">✗ Error de conexión:</span> ${error.message}`;
            }
        }

        async function testProcessPayment() {
            if (!authToken) {
                alert('Primero debes hacer login');
                return;
            }

            const resultDiv = document.getElementById('payment-result');
            
            try {
                const response = await fetch('/api/ventas/procesar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        metodoPago: 'TARJETA_CREDITO'
                    })
                });

                const data = await response.json();
                resultDiv.style.display = 'block';

                if (response.ok) {
                    resultDiv.innerHTML = `<span class="success">✓ Pago procesado:</span><br>
                        <strong>ID Venta:</strong> ${data.venta.idVenta}<br>
                        <strong>Total:</strong> $${data.venta.total}<br>
                        <strong>Estado:</strong> ${data.venta.estado}`;
                } else {
                    resultDiv.innerHTML = `<span class="error">✗ Error:</span> ${data.error || JSON.stringify(data)}`;
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<span class="error">✗ Error de conexión:</span> ${error.message}`;
            }
        }
    </script>
</body>
</html>